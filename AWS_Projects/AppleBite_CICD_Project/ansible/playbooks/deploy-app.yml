---
# Ansible Playbook: Deploy Application
# This playbook deploys the containerized application

- name: Deploy AppleBite Application
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    project_dir: "/opt/applebite"
    app_repo: "https://github.com/edureka-devops/projCert.git"
    app_branch: "master"

  tasks:
    - name: Display deployment information
      debug:
        msg: "Deploying application to {{ environment }} environment on {{ inventory_hostname }}"

    - name: Ensure project directory exists
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: "0755"

    - name: Clone or update application repository
      git:
        repo: "{{ app_repo }}"
        dest: "{{ project_dir }}/app"
        version: "{{ app_branch }}"
        force: yes
      register: git_result

    - name: Display git clone/update result
      debug:
        msg: "Git repository updated: {{ git_result.changed }}"

    - name: Copy Dockerfile to project directory
      copy:
        src: "../../docker/Dockerfile"
        dest: "{{ project_dir }}/Dockerfile"
        mode: "0644"

    - name: Copy Docker Compose file
      copy:
        src: "../../docker/docker-compose.{{ environment }}.yml"
        dest: "{{ project_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Stop existing containers
      command: docker-compose down
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: yes

    - name: Remove old Docker images (cleanup)
      command: docker image prune -f
      when: environment == "test"

    - name: Build Docker image
      command: docker-compose build
      args:
        chdir: "{{ project_dir }}"
      register: build_result

    - name: Display build result
      debug:
        msg: "Docker build completed"

    - name: Start containers
      command: docker-compose up -d
      args:
        chdir: "{{ project_dir }}"
      register: deploy_result

    - name: Wait for application to be ready
      wait_for:
        port: "{{ app_port }}"
        delay: 10
        timeout: 300
        msg: "Application failed to start within timeout"

    - name: Verify container status
      command: docker-compose ps
      args:
        chdir: "{{ project_dir }}"
      register: container_status
      changed_when: false

    - name: Display container status
      debug:
        msg: "{{ container_status.stdout_lines }}"

    - name: Check application health
      uri:
        url: "http://localhost:{{ app_port }}"
        method: GET
        status_code: 200
        timeout: 30
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200

    - name: Display deployment success message
      debug:
        msg: "Application deployed successfully to {{ environment }} environment at http://localhost:{{ app_port }}"

    - name: Send notification (placeholder)
      debug:
        msg: "Deployment notification: Application deployed to {{ environment }}"
      # In production, integrate with Slack, email, or other notification systems
