---
# Ansible Playbook: Rollback Application
# This playbook rolls back to the previous version

- name: Rollback AppleBite Application
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    project_dir: "/opt/applebite"

  tasks:
    - name: Display rollback information
      debug:
        msg: "Rolling back application in {{ environment }} environment on {{ inventory_hostname }}"

    - name: Stop current containers
      command: docker-compose down
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: yes

    - name: Get previous git commit
      shell: git log --pretty=format:"%H" -n 2 | tail -1
      args:
        chdir: "{{ project_dir }}/app"
      register: previous_commit
      changed_when: false

    - name: Display previous commit
      debug:
        msg: "Rolling back to commit: {{ previous_commit.stdout }}"

    - name: Checkout previous commit
      git:
        repo: "{{ project_dir }}/app"
        dest: "{{ project_dir }}/app"
        version: "{{ previous_commit.stdout }}"
      when: previous_commit.stdout != ""

    - name: Rebuild Docker image
      command: docker-compose build
      args:
        chdir: "{{ project_dir }}"

    - name: Start containers with previous version
      command: docker-compose up -d
      args:
        chdir: "{{ project_dir }}"

    - name: Wait for application to be ready
      wait_for:
        port: "{{ app_port }}"
        delay: 10
        timeout: 300

    - name: Verify rollback
      uri:
        url: "http://localhost:{{ app_port }}"
        method: GET
        status_code: 200
        timeout: 30
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200

    - name: Display rollback success message
      debug:
        msg: "Rollback completed successfully for {{ environment }} environment"
